import os
from PIL import Image

def make_fonts(asm_fonts_filepath, originals_dir, target_dir):
    # Scan the source directory for all font files ending in .png
    font_filenames = [f for f in os.listdir(originals_dir) if f.endswith('.png')]
    font_filenames.sort()

    # Initialize variables
    num_fonts = 0
    font_list = []
    files_list = []

    # Process the fonts
    for font_filename in font_filenames:
        # Open the .png image and get its dimensions
        img = Image.open(os.path.join(originals_dir, font_filename))
        img_width, img_height = img.size

        # Assume the font dimensions are 16 characters per row (for 256 characters, that would be 16x16 grid)
        num_chars_per_row = 16
        font_width = img_width // num_chars_per_row
        font_height = img_height // num_chars_per_row

        # Calculate the font file size (assume 1 byte per pixel, and it's a monochrome image)
        # Number of bytes per glyph = (font_width * font_height)
        # There are 256 glyphs in total, so total size is glyph_size * 256
        font_filesize = font_width * font_height * 256

        # Extract the base file name without extension
        file_name = os.path.splitext(font_filename)[0]

        # Add to font list (dimensions and file reference)
        font_list.append(f'\tdl {font_width}, {font_height}, {font_filesize}, fn_{file_name}\n')

        # Add the file to the file list (corresponding .font file path)
        files_list.append(f'fn_{file_name}: db "/{file_name}.font",0 \n')

        num_fonts += 1

    # Write the assembly file
    with open(asm_fonts_filepath, 'w') as f:
        f.write(f'; Generated by build_91b_asm_consolefont.py\n\n')

        f.write(f'num_fonts: equ {num_fonts}\n\n')

        f.write(f'_font_list: ; width; height; filename;:\n')
        f.write(''.join(font_list))
        f.write(f'\n')

        f.write(f'; files_list: ; filename:\n')
        f.write(''.join(files_list))

if __name__ == '__main__':
    asm_fonts_filepath = 'src/asm/fonts.inc'
    originals_dir = 'src/assets/consolefonts'
    target_dir = 'tgt/consolefonts'

    make_fonts(asm_fonts_filepath, originals_dir, target_dir)
